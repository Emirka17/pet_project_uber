# Архитектура системы

## Обзор

Pet Project Uber — микросервисное приложение для заказа такси, построенное по образцу реальных highload-систем.

---

## Общая схема

┌─────────────────────────────────────────────────────────────────────────────┐
│ КЛИЕНТЫ │
│ │
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│ │ Passenger │ │ Driver │ │ Admin │ │
│ │ App │ │ App │ │ Panel │ │
│ │ (React) │ │ (React) │ │ (React) │ │
│ │ :3001 │ │ :3002 │ │ :3003 │ │
│ └────────┬────────┘ └────────┬────────┘ └────────┬────────┘ │
│ │ │ │ │
└────────────┼─────────────────────┼─────────────────────┼────────────────────┘
│ │ │
└─────────────────────┼─────────────────────┘
│
▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ API GATEWAY (Go) │
│ :8080 │
│ │
│ • Единая точка входа • Rate limiting │
│ • Аутентификация (JWT) • Маршрутизация запросов │
│ • Логирование • Балансировка нагрузки │
└─────────────────────────────────────────────────────────────────────────────┘
│
┌─────────────────────────┼─────────────────────────┐
│ │ │
▼ ▼ ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ Auth Service │ │ User Service │ │ Driver Service │
│ (Go) │ │ (Python) │ │ (Python) │
│ :8000 │ │ :8001 │ │ :8002 │
└─────────────────┘ └─────────────────┘ └─────────────────┘

┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ Ride Service │ │Matching Service │ │ Geo Service │
│ (Python) │ │ (Go) │ │ (Go) │
│ :8003 │ │ :8004 │ │ :8005 │
└─────────────────┘ └─────────────────┘ └─────────────────┘

┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│Pricing Service │ │Payment Service │ │ Notification │
│ (Python) │ │ (Python) │ │ Service │
│ :8006 │ │ :8007 │ │ (Python) │
│ │ │ │ │ :8008 │
└─────────────────┘ └─────────────────┘ └─────────────────┘

┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ ML Service │ │ AB Test Service │ │ Analytics │
│ (Python) │ │ (Python) │ │ Service │
│ :8009 │ │ :8010 │ │ (Python) │
│ │ │ │ │ :8011 │
└─────────────────┘ └─────────────────┘ └─────────────────┘
│ │ │
└─────────────────────────┼─────────────────────────┘
│
▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ KAFKA │
│ :9092 │
│ │
│ Topics: │
│ • rides.created • rides.completed • payments.processed │
│ • rides.assigned • rides.cancelled • notifications.send │
│ • drivers.online • drivers.location • analytics.events │
└─────────────────────────────────────────────────────────────────────────────┘
│
┌─────────────────────────┼─────────────────────────┐
│ │ │
▼ ▼ ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ PostgreSQL │ │ Redis │ │ ClickHouse │
│ :5432 │ │ :6379 │ │ :8123 │
│ │ │ │ │ │
│ • users │ │ • sessions │ │ • ride_events │
│ • drivers │ │ • driver
│ │ • user_events │
│ • rides │ │ • cache │ │ • daily_stats │
│ • payments │ │ • rate_limit │ │ │
│ • tariffs │ │ • drivers
│ │ (добавим │
│ • vendors │ │ │ │ позже) │
└─────────────────┘ └─────────────────┘ └─────────────────┘


---

## Микросервисы

### Описание сервисов

| Сервис | Язык | Порт | Ответственность |
|--------|------|------|-----------------|
| **API Gateway** | Go | 8080 | Точка входа, аутентификация, роутинг |
| **Auth Service** | Go | 8000 | Регистрация, логин, JWT токены |
| **User Service** | Python | 8001 | CRUD пользователей |
| **Driver Service** | Python | 8002 | CRUD водителей, статус онлайн |
| **Ride Service** | Python | 8003 | Создание и управление поездками |
| **Matching Service** | Go | 8004 | Поиск и назначение водителей |
| **Geo Service** | Go | 8005 | Геолокация, поиск рядом |
| **Pricing Service** | Python | 8006 | Расчёт стоимости поездки |
| **Payment Service** | Python | 8007 | Обработка платежей |
| **Notification Service** | Python | 8008 | Push, SMS, Email уведомления |
| **ML Service** | Python | 8009 | Прогноз ETA, спроса, цен |
| **AB Test Service** | Python | 8010 | A/B эксперименты |
| **Analytics Service** | Python | 8011 | Сбор и обработка аналитики |

---

### Почему Go и Python

| Сервис | Язык | Причина |
|--------|------|---------|
| API Gateway | Go | Высокая производительность, много соединений |
| Auth Service | Go | Скорость, криптография |
| Matching Service | Go | Критичен по скорости, много параллельных операций |
| Geo Service | Go | Быстрые вычисления, работа с Redis Geo |
| Остальные | Python | Быстрая разработка, ML библиотеки, простота |

---

## Базы данных

### PostgreSQL (основная)

**Назначение:** Хранение основных данных (источник правды).

**Таблицы:**
- `users` — пользователи
- `drivers` — водители
- `rides` — поездки
- `payments` — платежи
- `tariffs` — тарифы
- `vendors` — поставщики

**Когда используется:**
- Регистрация пользователя
- Создание поездки
- Сохранение платежа
- Любые данные, которые нельзя потерять

---

### Redis (кэш)

**Назначение:** Быстрый доступ к часто используемым данным.

**Что хранит:**

| Ключ | Тип | TTL | Описание |
|------|-----|-----|----------|
| `session:{user_id}` | STRING | 24h | JWT токен |
| `driver:location:{id}` | HASH | — | Координаты водителя |
| `drivers:online` | SET | — | ID онлайн водителей |
| `drivers:geo` | GEO | — | Гео-индекс водителей |
| `cache:tariffs` | STRING | 1h | Кэш тарифов |
| `rate_limit:{ip}` | STRING | 1m | Счётчик запросов |

**Когда используется:**
- Проверка токена (каждый запрос)
- Поиск водителей рядом
- Rate limiting

---

### ClickHouse (аналитика)

**Назначение:** Быстрая аналитика на больших данных.

**Статус:** Добавим позже.

**Что будет хранить:**
- События поездок
- Метрики для дашбордов
- Данные для ML

---

## Kafka

### Назначение

Асинхронная коммуникация между сервисами.

### Топики

| Топик | Продюсер | Консьюмеры | Описание |
|-------|----------|------------|----------|
| `rides.created` | Ride Service | Matching, Analytics | Новая поездка создана |
| `rides.assigned` | Matching Service | Notification, Analytics | Водитель назначен |
| `rides.started` | Ride Service | Analytics | Поездка началась |
| `rides.completed` | Ride Service | Payment, Analytics | Поездка завершена |
| `rides.cancelled` | Ride Service | Notification, Analytics | Поездка отменена |
| `drivers.online` | Driver Service | Matching, Analytics | Водитель вышел на линию |
| `drivers.offline` | Driver Service | Matching, Analytics | Водитель ушёл с линии |
| `drivers.location` | Driver Service | Geo Service | Обновление координат |
| `payments.processed` | Payment Service | Notification, Analytics | Платёж обработан |
| `notifications.send` | Различные | Notification Service | Команда отправить уведомление |
| `analytics.events` | Все сервисы | Analytics Service | События для аналитики |

---

## Потоки данных

### Заказ поездки

┌──────────────────────────────────────────────────────────────────────────┐
│ 1. Пассажир нажимает "Заказать" │
└──────────────────────────────────────────────────────────────────────────┘
│
▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 2. API Gateway │
│ • Проверяет JWT токен в Redis │
│ • Проверяет rate limit │
│ • Направляет запрос в Ride Service │
└──────────────────────────────────────────────────────────────────────────┘
│
▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 3. Ride Service │
│ • Валидирует данные │
│ • Запрашивает цену у Pricing Service │
│ • Создаёт поездку в PostgreSQL (status: pending) │
│ • Публикует событие rides.created в Kafka │
└──────────────────────────────────────────────────────────────────────────┘
│
▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 4. Matching Service (слушает rides.created) │
│ • Запрашивает ближайших водителей у Geo Service │
│ • Выбирает лучшего (по рейтингу, расстоянию) │
│ • Обновляет поездку в PostgreSQL (status: assigned) │
│ • Публикует событие rides.assigned в Kafka │
└──────────────────────────────────────────────────────────────────────────┘
│
▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 5. Notification Service (слушает rides.assigned) │
│ • Отправляет push пассажиру: "Водитель найден" │
│ • Отправляет push водителю: "Новый заказ" │
└──────────────────────────────────────────────────────────────────────────┘
│
▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 6. Analytics Service (слушает все события) │
│ • Записывает события в ClickHouse │
└──────────────────────────────────────────────────────────────────────────┘

---

### Поиск водителей рядом

┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ Matching Service│────▶│ Geo Service │────▶│ Redis │
└─────────────────┘ └─────────────────┘ └─────────────────┘
│
Запрос: │
"Найди водителей ▼
в радиусе 3 км ┌─────────────────┐
от точки (40.7, -74.0)" │ GEORADIUS │
│ drivers
│
│ 40.7 -74.0 │
Ответ: │ 3 km │
[driver_1, driver_5, driver_12] └─────────────────┘

---

### Обновление координат водителя

┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ Driver App │────▶│ Driver Service │────▶│ Kafka │
│ (каждые 5 сек) │ │ │ │ drivers.location│
└─────────────────┘ └─────────────────┘ └─────────────────┘
│
▼
┌─────────────────┐
│ Geo Service │
│ (consumer) │
└─────────────────┘
│
▼
┌─────────────────┐
│ Redis │
│ GEOADD │
│ drivers
│
└─────────────────┘

---

## Инфраструктура

### Docker Compose (разработка)

────────┐
│ Docker на твоём Mac │
│ │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│ │ postgres │ │ redis │ │ kafka │ │
│ │ :5432 │ │ :6379 │ │ :9092 │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ │
│ │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│ │ zookeeper │ │ kafka-ui │ │ metabase │ │
│ │ :2181 │ │ :9093 │ │ :3000 │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ │
│ │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│ │ api-gateway │ │user-service │ │ride-service │ ... │
│ │ :8080 │ │ :8001 │ │ :8003 │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ │
│ │
│ uber_network │
└─────────────────────────────────────────────────────────────────┘


---

### Kubernetes (production)

┌─────────────────────────────────────────────────────────────────┐
│ Kubernetes Cluster │
│ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Namespace: uber │ │
│ │ │ │
│ │ ┌─────────┐ ┌─────────┐ ┌─────────┐ │ │
│ │ │postgres │ │ redis │ │ kafka │ Deployments │ │
│ │ │ pod x1 │ │ pod x1 │ │ pod x1 │ │ │
│ │ └─────────┘ └─────────┘ └─────────┘ │ │
│ │ │ │
│ │ ┌─────────┐ ┌─────────┐ ┌─────────┐ │ │
│ │ │api-gw │ │user-svc │ │ride-svc │ Deployments │ │
│ │ │ pod x2 │ │ pod x2 │ │ pod x2 │ (replicas: 2) │ │
│ │ └─────────┘ └─────────┘ └─────────┘ │ │
│ │ │ │
│ │ ┌─────────────────────────────────────────────────┐ │ │
│ │ │ Ingress Controller │ │ │
│ │ │ (nginx) │ │ │
│ │ └─────────────────────────────────────────────────┘ │ │
│ │ │ │
│ └─────────────────────────────────────────────────────────┘ │
│ │
└─────────────────────────────────────────────────────────────────┘
│
▼
┌─────────────────┐
│ Load Balancer │
│ uber.local │
└─────────────────┘


---

## Масштабирование

### Горизонтальное масштабирование

| Компонент | Как масштабируется |
|-----------|-------------------|
| API Gateway | Добавить реплики, балансировщик распределит нагрузку |
| Микросервисы | Добавить реплики (stateless) |
| PostgreSQL | Read replicas для чтения |
| Redis | Redis Cluster |
| Kafka | Добавить брокеры, увеличить партиции |

---

### Что stateless, что stateful

| Компонент | Тип | Почему |
|-----------|-----|--------|
| API Gateway | Stateless | Не хранит состояние |
| User Service | Stateless | Состояние в БД |
| Ride Service | Stateless | Состояние в БД |
| PostgreSQL | Stateful | Хранит данные |
| Redis | Stateful | Хранит данные |
| Kafka | Stateful | Хранит сообщения |

---

## Отказоустойчивость

### Что если упадёт сервис

| Сервис | Последствия | Решение |
|--------|-------------|---------|
| API Gateway | Приложение недоступно | Несколько реплик за балансировщиком |
| User Service | Нельзя зарегистрироваться | Реплики, retry |
| Ride Service | Нельзя заказать поездку | Реплики, очередь в Kafka |
| Matching Service | Водители не назначаются | События ждут в Kafka |
| PostgreSQL | Потеря данных | Реплики, бэкапы |
| Redis | Потеря сессий | Persistence, Cluster |
| Kafka | Потеря событий | Репликация, persistence |

---

## Безопасность

### Аутентификация

┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ Client │────▶│ API Gateway │────▶│ Auth Service │
│ │ │ │ │ │
│ Authorization: │ │ Проверяет JWT │ │ Выдаёт JWT │
│ Bearer <token> │ │ в Redis │ │ при логине │
└─────────────────┘ └─────────────────┘ └─────────────────┘

### Rate Limiting

Клиент → API Gateway → Redis (INCR rate_limit:{ip})
│
├─ count < 100 → пропустить
└─ count >= 100 → 429 Too Many Requests


## Мониторинг (будущее)

| Инструмент | Назначение |
|------------|------------|
| Prometheus | Сбор метрик |
| Grafana | Визуализация метрик |
| ELK Stack | Логи |
| Jaeger | Distributed tracing |

---

## Технологический стек

| Категория | Технологии |
|-----------|------------|
| **Backend** | Go, Python (FastAPI) |
| **Frontend** | React |
| **Databases** | PostgreSQL, Redis, ClickHouse |
| **Message Broker** | Apache Kafka |
| **Containers** | Docker, Kubernetes |
| **CI/CD** | GitHub Actions |
| **Monitoring** | Prometheus, Grafana |
| **BI** | Metabase |